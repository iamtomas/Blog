![image](https://user-images.githubusercontent.com/83901620/127632240-36d87179-f0d2-4b52-9a4c-09235642fd12.png)

## 前言

参考自 [MySQL 是怎样运行的：从根儿上理解 MySQL
](https://juejin.cn/book/6844733769996304392/section/6844733769945972749)

### 关于工具

“Jeremy Cole 已经使用 Ruby 开发了一个简易的解析这些基础结构的工具，github地址是：[innodb_ruby](https://github.com/jeremycole/innodb_ruby) ，大家可以按照说明安装上这个工具，可以更好的理解 InnoDB 中的一些存储结构（此工具虽然是针对 MySQL 5.6的，但是幸好MySQL 的基础存储结构基本没多大变化，所以大部分场景下这个 innodb_ruby 工具还是可以使用的）。”

#### 关于安装

重点关注 bin 目录下的可执行文件 （以 mac 为例）：

`$ cd /usr/local/mysql/bin && ls`

``` bash
.
├── mysql
├── mysql.server -> ../support-files/mysql.server
├── mysqladmin
├── mysqlbinlog
├── mysqlcheck
├── mysqld
├── mysqld_multi
├── mysqld_safe
├── mysqldump
├── mysqlimport
├── mysqlpump
... (省略其他文件)
0 directories, 40 files
```

- mysqld : 启动服务器进程
- mysqld_safe ： 在 mysqld 的基础上，启动了一个监控进程。当服务器进程挂了，可以帮助重启。另外还可以将错误信息重定向到某个文件中，方便我们查看错误原因
- mysql.server ： 其实是一个链接文件，它的实际文件是 `../support-files/mysql.server`。命令有 `mysql.server [start/stop]`
- mysqld_multi : 运行多个服务器进程，可以对每一个服务器进程的启动或停止进行监控，这个命令的使用比较复杂，可以查阅其他资料了解


## 1) 连接管理

MySQL 支持三种客服端进程和服务器进程通信的方式

- TCP/IP
- 命名管道和共享内存(pipe/share memory)
- UNIX域套接字(socket)

### TCP/IP

大多情况，客户端和服务器端运行在不同的主机，MySQL 采用 TCP 作为它们之间通信的协议。在网络环境下，每台主机都有唯一的 IP 地址，如果某个进程需要采用 TCP 协议进行通信方面的需求，会向操作系统申请一个端口号（0~65535），这样其他进程就可以通过 `IP 地址 + 端口号` 的方式建立连接

MySQL 服务器启动默认监听 3306 端口，如果被占用了，可以通过 `mysqld -P3307`

如果客户端想要使用 TCP/IP 来连接服务器，可以使用 `mysql -h127.0.0.1 -uroot -P3007 -p`

在客户端与服务器断开连接时，MySQL 不会立即把与客户端交互的线程销毁掉，而是把它缓存起来，等与另一个客户端连接时会分配给它，从而达到**减少进程的频繁销毁创建**

客户端连接服务器时，需要经过一系列的认证（用户名、密码及主机信息等）。如果客户端和服务器端不在一台计算机上，还可以采用 SSL（安全套接字）的网络连接进行通信，保证数据传输的安全性

### 命名管道和共享内存

在 Windows 中，进程之间还可以考虑使用 `命名管道` 或 `共享内存` 通信

命名管道： 服务器启动时加上 `--enable-named-pipe` 参数，启动客户端时加上 `-pipe` 或 `--protocol=pipe`

共享内存：服务器启动时加上 `--shared-memory` 参数，启动客户端时加上 `--protocol=memory`，不过需要注意的是，进程必须在同一台 Windows 主机上

### Unix域套接字文件

在类 Unix 的机器中，如果客户端和服务器端在同一台操作系统上，则可以使用 `Unix域套接字文件` 进行进程间通信

启动客户端时指定主机名为 `localhost` 或指定了 `--protocol=socket` 的启动参数，就可以使用`Unix域套接字文件` 进行进程间通信了，MySQL服务器程序默认监听的 Unix 域套接字文件路径 `为/tmp/mysql.sock`，如果我们想改变这个默认路径，可以在启动服务器程序时指定 socket 参数 `mysqld --socket=/tmp/a.txt`，修改后，客户端也需要做出修改 `mysql -hlocalhost -uroot --socket=/tmp/a.txt -p` 

## 2) 查询缓存

它的作用很明显，用于缓存查询请求和结果，并且可以在不同的客户端之间共享

更重要的，它存在缓存失效的时候，MySQL的缓存系统会监测涉及到的每张表，只要该表的结构或者数据被修改（如 INSERT、UPDATE 等），那该表的所有缓存查询都将变为无效并被删除

注：从 MySQL 5.7.20开始，不推荐使用查询缓存，并在 MySQL 8.0中删除

## 3）语法解析

如果没有命中缓存，则需要对这段文本(SQL)做分析，这个过程涉及语法分析、语义分析等阶段，暂不在此深挖

## 4）查询优化

MySQL 的优化程序会对我们的语句做一些优化，结果就是生成一个执行计划

## 5）存储引擎

截至到查询优化为止，还没真正访问到真实的数据库，MySQL 服务器把数据的存储和提取操作封装到了存储引擎的模块里

常用的存储引擎

- InnoDB：具备外键支持功能的事务存储引擎
- MEMORY：置于内存的表
- MyISAM：主要的非事务处理存储引擎
- ...

## 6）启动选项和系统变量

启动时有两种方式：启动命令加选项 + 配置文件（如：my.ini 或 my.cnf）

系统变量：影响服务器运行行为的变量

- 查看方式：`SHOW VARIABLES [LIKE 匹配的模式];`

另外的状态变量，是用于查看当前服务器运行的情况，比如：当前有多少客户端与服务器建立了连接等

## 7）字符集和比较规则








---

## 乐观锁和悲观锁

**乐观锁**

定义：在操作数据时比较乐观，认为别人不会不会同时修改数据，只是在更新时判断这期间有没人修改，如果有，则放弃继续操作

实现方式：**CAS** 或 **版本号**

CAS (Compare And Swap) 

主要有三部分：1）需要读写的内存位置  2）预期值  3）写入的新值

CAS 原理：如果内存位置的值等于预期的值，则将该位置更新为新值，否则不进行任何操作。许多CAS的操作是自旋的：如果操作不成功，会一直重试，直到操作成功为止。

注：CAS是由CPU支持的原子操作，其原子性是在硬件层面进行保证的。

**悲观锁**

定义：在操作数据时比较悲观，认为别人会同时修改数据，因此操作数据时直接给数据锁住，直到操作完成后才释放


**实践**

可通过 **开启1000个线程来实现自增的方式** 比较 乐观锁(CAS) 和 悲观锁 以及 没进行任何线程安全方面保护的对象，会发现除了 乐观锁 和 悲观锁 没问题，其他的偏少

**优缺点和适用场景**

- 乐观锁适用的场景受到了更多的限制（如CAS只能保证**单个**变量操作的原子性，版本号不能解决多表的情况）
- 竞争不激烈，乐观锁更有优势，因为悲观锁会锁住代码块或数据，其他线程无法同时访问，影响并发，而且加锁和释放锁都需要消耗额外的资源；竞争激烈时，乐观锁在执行更新时频繁失败，需要不断重试，浪费CPU资源

**拓展**

CAS 有哪些缺点

- ABA 问题
- 高竞争下的开销问题（频繁重试）
- 功能限制（只能保证单个变量操作的原子性）

参考：https://www.cnblogs.com/kismetv/p/10787228.html
